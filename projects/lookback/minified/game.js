/*******************************************************************************
 * Copyright (c) 2019.
 * Developed by Adam Hodgkinson
 * Last modified 02/09/2019, 18:38
 ******************************************************************************/

var offScreenCanvas,offScreenContext,GAME,debug=!1;const PLAYER_HEIGHT=26,PLAYER_WIDTH=26,PLAYER_GRAVITY=600,PLAYER_JUMP_SPEED=300,PLAYER_X_SPEED=200,PLAYER_FRICTION=.9;class Game{constructor(){console.log("play"),this.preload(),this.create(),this.startTime=0,this.timeElapsed=0,this.timeLimit=0}preload(){this.level=parseInt(new URLSearchParams(window.location.search).get("level")),this.level||(window.location.search="level=1"),this.levelUrl="map"+this.level,this.cvs=document.getElementById("gameCanvas"),this.ctx=this.cvs.getContext("2d")}create(){this.map=new Map("mapData/"+this.levelUrl+".json",this.cvs.width,this.cvs.height),this.player=new Player,document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp)}update(t){this.player.update(t),this.attemptInProgress&&(this.timeElapsed=Math.floor((Date.now()-this.startTime)/1e3),document.getElementById("time-display").innerText="Time Elapsed: "+this.timeElapsed,this.timeElapsed>this.timeLimit&&this.fail()),this.render()}fail(){this.attemptInProgress=!1,this.attemptFailed=!0,document.getElementById("message-box").style.display="block",document.getElementById("message").innerHTML="You Failed this attempt!<br>Press any key to re-try.<br>Note: The timer and ghost don't begin until you do"}success(){document.getElementById("message-box").style.display="block",document.getElementById("message").innerHTML="Congrats, you completed this level!<br>Press any key to progress to the next level",this.attemptSucceeded=!0,console.log("succeed")}reset(){document.getElementById("message-box").style.display="none",this.player.resetAttempt(),this.timeElapsed=0,this.attemptInProgress=!1,this.attemptFailed=!1,this.startTime=0}render(){offScreenContext.clearRect(0,0,offScreenCanvas.width,offScreenCanvas.height),this.ctx.clearRect(0,0,this.cvs.width,this.cvs.height),this.player.draw(),this.attemptInProgress,this.ctx.drawImage(offScreenCanvas,0,0)}handleKeyDown(t){switch(0==GAME.startTime&&GAME.start(),t.code){case"ArrowUp":case"KeyW":GAME.player.upPressed=!0;break;case"ArrowDown":case"KeyS":GAME.player.downPressed=!0;break;case"ArrowLeft":case"KeyA":GAME.player.leftPressed=!0;break;case"ArrowRight":case"KeyD":GAME.player.rightPressed=!0}}handleKeyUp(t){if(GAME.attemptSucceeded&&(window.location.search="level="+(GAME.level+1)),GAME.attemptFailed)return void GAME.reset();switch(t.code){case"KeyR":GAME.fail();break;case"ArrowUp":case"KeyW":GAME.player.upPressed=!1;break;case"ArrowDown":case"KeyS":GAME.player.downPressed=!1;break;case"ArrowLeft":case"KeyA":GAME.player.leftPressed=!1;break;case"ArrowRight":case"KeyD":GAME.player.rightPressed=!1}}start(){this.attemptInProgress=!0,console.log("started"),this.startTime=Date.now(),document.getElementById("message-box").style.display="none",this.player.currentPath={keys:[]}}}class Map{constructor(t,e,s){this.data=[],this.winbox={};let i=this.loadMap(t);i.then(t=>{this.data=t,this.drawMap(this.data)}),i.catch(t=>{console.log(t)}),this.cvs=document.createElement("canvas"),this.cvs.width=e,this.cvs.height=s,this.ctx=this.cvs.getContext("2d")}drawMap(t){console.log(t);for(let e=0;e<t.length;e++){let s=t[e];console.log(s),s.config?(GAME.timeLimit=s.timeLimit,document.getElementById("time-limit-display").innerText="Time limit: "+s.timeLimit,GAME.player.startX=s.startX,GAME.player.startY=s.startY):(s.winbox?(this.ctx.fillStyle="green",this.ctx.globalAlpha=.3,this.winbox=s):this.ctx.fillStyle=s.colour,this.ctx.fillRect(s.x,s.y,s.width,s.height),this.ctx.globalAlpha=1)}document.getElementById("backgroundCanvas").getContext("2d").drawImage(this.cvs,0,0)}async loadMap(t){return new Promise((e,s)=>{let i=new XMLHttpRequest;i.open("GET",t),i.onload=(()=>e(JSON.parse(i.responseText))),i.onerror=(()=>s(i.statusText)),i.send()})}}class Player{constructor(){this.height=PLAYER_HEIGHT,this.width=PLAYER_WIDTH,this.x=100,this.xv=0,this.xSpeed=PLAYER_X_SPEED,this.friction=PLAYER_FRICTION,this.yv=0,this.jumpSpeed=PLAYER_JUMP_SPEED,this.gravity=PLAYER_GRAVITY,this.y=400,this.currentPath={keys:[]},this.pastPath={},this.startX=100,this.startY=100,this.upPressed=!1,this.leftPressed=!1,this.rightPressed=!1,this.downPressed=!1,this.onGround=!0,this.jumpAvailable=!0,this.collisionJumpAvailable=!0}resetAttempt(){this.x=this.startX,this.y=this.startY,this.pastPath=this.currentPath,this.currentPath={keys:[]},this.xv=0,this.yv=0}draw(){if(debug&&(offScreenContext.fillStyle="green",offScreenContext.fillRect(Math.floor(this.x-this.width/2),Math.floor(this.y-this.height/2),this.width,this.height)),!this.pastPath.keys)return;let t=this.calculatePosition(Date.now()-GAME.startTime);offScreenContext.fillStyle="red",offScreenContext.fillRect(Math.floor(t.x-this.width/2),Math.floor(t.y-this.height/2),this.width,this.height)}update(t){if(GAME.attemptFailed)return;this.upPressed&&this.up(),this.leftPressed&&this.left(),this.rightPressed&&this.right(),this.onGround||(this.yv+=this.gravity*t),this.x+=this.xv*t,this.y+=this.yv*t,this.checkOnGround(),this.xv*=this.friction*t,this.xv<.01&&this.xv>-.01&&(this.xv=0),this.checkCollisionWithMap();let e=Date.now()-GAME.startTime;this.currentPath[e]={x:this.x,y:this.y},this.currentPath.keys.push(e)}checkCollisionWithMap(){if(this.currentPath.keys[0])for(let t of GAME.map.data)if(!t.config&&!t.permeable){if(this.x-1+this.width/2>t.x&&this.x-this.width/2<t.x+t.width&&this.y-1+this.height/2>t.y&&this.y-this.width/2<t.y+t.height){if(t.winbox){this.reachEnd();break}if(t.deadly){GAME.fail();break}return console.log("Attempting to resolve collision"),void this.resolveCollision(t)}if(intersects(t.x,t.y,t.x+t.width,t.y+t.height,this.x,this.y,this.currentPath[this.currentPath.keys[this.currentPath.keys.length-1]].x,this.currentPath[this.currentPath.keys[this.currentPath.keys.length-1]].y)){if(t.deadly){GAME.fail();break}return void this.resolveCollision(t)}}}resolveCollision(t){!this.jumpAvailable&&this.collisionJumpAvailable&&(this.jumpAvailable=!0,this.collisionJumpAvailable=!1);let e=this.currentPath[this.currentPath.keys[this.currentPath.keys.length-1]],s=e.x-this.x,i=e.y-this.y,h=0;for(;;){let e=(h+=2)/100,a=this.x+s*e,r=this.y+i*e;if(!this.checkCollideWithItem({x:a,y:r,width:this.width,height:this.height},t)){this.x=a,this.y=r,this.yv=0,this.onGround=!0;break}}}checkCollideWithItem(t,e){if(t.x-1+t.width/2>e.x&&t.x-this.width/2<e.x+e.width&&t.y-1+t.height/2>e.y&&t.y-t.height/2<e.y+e.height)return!0;let s=this.currentPath[this.currentPath.keys[this.currentPath.keys.length-1]];return!!intersects(e.x,e.y,e.x+e.width,e.y+e.height,t.x,t.y,s.x,s.y)}reachEnd(){GAME.success()}checkOnGround(){this.onGround=!1;for(let t of GAME.map.data)if(!t.config&&!t.permeable&&Math.floor(this.y)+this.height/2==Math.floor(t.y)&&this.x-this.width/2<t.x+t.width&&this.x+this.width/2>t.x)return this.jumpAvailable=!0,this.collisionJumpAvailable=!0,this.onGround=!0,!0}calculatePosition(t){let e=closest(t,this.pastPath.keys);return{x:this.pastPath[e].x,y:this.pastPath[e].y}}up(){this.jumpAvailable&&(this.yv=-this.jumpSpeed,this.jumpAvailable=!1)}left(){this.xv=-this.xSpeed}right(){this.xv=this.xSpeed}}window.onload=function(){focus(),GAME=new Game,(offScreenCanvas=document.createElement("canvas")).width=GAME.cvs.width,offScreenCanvas.height=GAME.cvs.height,offScreenContext=offScreenCanvas.getContext("2d"),globalDraw()};var now,delta,calc,fps=100,then=Date.now(),interval=1e3/fps;let timeSinceFpsUpdate=0;function globalDraw(){requestAnimationFrame(globalDraw),now=Date.now(),(delta=now-then)>interval&&(then=now-delta%interval,calc=delta/1e3,(timeSinceFpsUpdate+=delta)>2e3&&(document.getElementById("fps-counter").innerText="FPS: "+Math.floor(1e3/delta),timeSinceFpsUpdate=0),GAME.update(calc))}function intersects(t,e,s,i,h,a,r,l){var n,o,c;return 0!==(n=(s-t)*(l-a)-(r-h)*(i-e))&&(o=((e-i)*(r-t)+(s-t)*(l-e))/n,0<(c=((l-a)*(r-t)+(h-r)*(l-e))/n)&&c<1&&0<o&&o<1)}function closest(t,e){for(var s,i=0,h=e.length-1;h-i>1;)e[s=Math.floor((i+h)/2)]<t?i=s:h=s;return t-e[i]<=e[h]-t?e[i]:e[h]}